/**
 *
 * Backbone-DocumentModel v0.6.0
 *
 * Copyright (c) 2013 Michael Haselton & Aaron Herres, Loqwai LLC
 *
 * https://github.com/icereval/backbone-documentmodel
 * Licensed under the MIT License
 */

!function(e){"function"==typeof define&&define.amd?define(["underscore","backbone"],e):e(_,Backbone)}(function(e,t){function o(e){return this.pseudoIdAttribute?this.findWhere({value:e}):t.Collection.prototype.get.call(this,e)}function n(o){if(!e.isString(o))return t.Model.prototype.get.call(this,o);var n=e.isArray(o)?o:o.split("."),i=t.Model.prototype.get.call(this,n.shift());return void 0===i?void 0:(e.each(n,function(t){var o;void 0!==i&&(o=parseInt(t,10),i=e.isFinite(o)?i.at(o):i.get(t))},this),i)}function i(e,o){return o||(o={}),delete o.name,delete o.parent,t.Collection.prototype.set.call(this,e,o)}function r(o,n){if(e.extend(n,e.pick(this.idAttribute?this:e.isObject(o)?o:this,["idAttribute"])),!e.isObject(o)){var i=o;this.pseudoIdAttribute=!0,o={},o[n.idAttribute]=e.uniqueId(),o.value=i}return t.Collection.prototype._prepareModel.call(this,o,n)}function s(o,n,i){var r,s,a={},c={};return null==o?this:("object"==typeof o?(r=o,i=n):(r={})[o]=n,i||(i={}),s=r instanceof t.Collection||r instanceof t.Model,s||e.each(e.keys(r),function(t){t.indexOf(".")>0?(c[t]=r[t],delete r[t]):e.isObject(r[t])&&(a[t]=r[t],delete r[t])}),t.Model.prototype.set.call(this,r,i)?(s||(e.each(e.keys(c),function(t){for(var o=t.split("."),n=o.pop(),r=!1,s=a,l=0;l<o.length;l++){var u=o[l],d=o[l+1];if(e.isFinite(d)){var p=e.reduce(o,function(e,t){return e+"."+t}),h=this.get.call(this,p);h&&h.set(n,c[t],i),r=!0;break}s[u]||(s[u]={}),s=s[u]}r||(s[n]=c[t])},this),e.each(e.keys(a),function(o){var n,r=a[o];this.attributes[o]?this.attributes[o].set.call(this.attributes[o],r,i):(n={parent:this},e.extend(n,e.pick(this,["idAttribute"])),n.name=o,e.isArray(r)?t.Model.prototype.set.call(this,o,new t.DocumentCollection(r,n),i):this instanceof t.DocumentModel&&(r instanceof t.DocumentModel?(r.get(this.idAttribute)||(r.set(this.idAttribute,this.get(this.idAttribute),{silent:!0}),n.pseudoIdAttribute=!0),e.extend(r,n),t.Model.prototype.set.call(this,o,r,i)):r[this.idAttribute]||(r[this.idAttribute]=this.get(this.idAttribute),n.pseudoIdAttribute=!0,t.Model.prototype.set.call(this,o,new t.DocumentModel(r,n),i))))},this)),this):!1)}function a(){var o,n=[];if(this instanceof t.Collection){var i=this.models;o=[],e.each(e.keys(i),function(e){var t=i[e].toJSON();this.pseudoIdAttribute&&(t=t.value),o.push(t)},this)}else if(this instanceof t.Model&&this.attributes){var r=this.attributes;o={},e.each(e.keys(r),function(e){(r[e]instanceof t.Model||r[e]instanceof t.Collection)&&n.push(e)}),this.pseudoIdAttribute&&delete r[this.idAttribute],o=e.omit(r,n),e.each(n,function(e){o[e]=r[e].toJSON()})}return o}function c(t){var o=t.split(":"),n=o[0],i=o.length>1?e.last(o,o.length-1)[0].split("."):[],r=Array.prototype.slice.call(arguments,0);if("change"!==t){i.unshift(this.name);var s=e.reduce(i,function(e,t){return e+"."+t});r[0]=n+":"+s,this.parent.trigger.apply(this.parent,r)}}function l(o){if(t.Events.trigger.apply(this,arguments),this._events){var n=e.filter(e.keys(this._events),function(e){var t=!1;return o!==e&&("change"===o.substring(0,6)?o.indexOf(".")>=0&&(t=!0):t=!0),t&&e.indexOf(":")>=0&&o.indexOf(":")>=0&&o.match(e)});if(n.length){var i=Array.prototype.slice.call(arguments,0);e.each(n,function(e){i[0]=e,t.Events.trigger.apply(this,i)},this)}}}function u(e,o,n){for(var i=this;i.parent||i.collection&&i.collection.parent;)i=i.parent||i.collection.parent;return t.Model.prototype.save.call(i,e,o,n)}function d(){return new this.constructor(this.toJSON())}var p=t.Model.extend({constructor:function(o,n){n||(n={}),e.extend(this,e.pick(n,["idAttribute","parent","name","pseudoIdAttribute"])),t.Model.apply(this,arguments),this.on("all",function(){this.parent&&this.name&&c.apply(this,arguments)},this)},pseudoIdAttribute:!1,toJSON:a,get:n,set:s,save:u,clone:d,trigger:l}),h=t.Collection.extend({constructor:function(o,n){n||(n={}),e.extend(this,e.pick(n,["idAttribute","parent","name"])),t.Collection.apply(this,arguments),this.on("all",function(){this.parent&&this.name&&c.apply(this,arguments)},this)},pseudoIdAttribute:!1,model:p,toJSON:a,get:o,set:i,clone:d,trigger:l,_prepareModel:r});return t.DocumentModel=p,t.DocumentCollection=h,"undefined"!=typeof module&&(module.exports=p),t});